{% extends "SistemaPedidosWebApp/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-5">

  <!-- ===== TÍTULO PRINCIPAL ===== -->
  <div class="text-center mb-5">
    <h1 class="fw-bold tienda-titulo">Nuestra Tienda</h1>
    <p class="text-secondary mb-0">Explorá nuestros productos y agregá al carrito lo que más te guste</p>
  </div>

  {% if query %}
    <div class="alert alert-dark text-center mt-3 w-75 mx-auto">
      Mostrando resultados para: <strong>"{{ query }}"</strong>
      {% if categoria_seleccionada %}
        en la categoría <strong>{{ categoria_seleccionada.nombre }}</strong>
      {% endif %}
    </div>
  {% endif %}

  <!-- ===== LAYOUT PRINCIPAL ===== -->
  <div class="row justify-content-center">

    <!-- ===== CATEGORÍAS ===== -->
    <aside class="col-12 col-md-3 col-lg-2 mb-4">
      <div class="filtro-categorias p-3 rounded shadow-sm">
        <h5 class="text-light fw-bold mb-3 text-center">Categorías</h5>
        <ul class="list-unstyled m-0">
          <li>
            <a href="{% url 'Tienda' %}" 
               class="categoria-link {% if not categoria_seleccionada %}activa{% endif %}">
              Todos los productos
            </a>
          </li>
          {% for cat in categorias %}
          <li>
            <a href="{% url 'productos_por_categoria' cat.id %}" 
               class="categoria-link {% if categoria_seleccionada and categoria_seleccionada.id == cat.id %}activa{% endif %}">
              {{ cat.nombre }}
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>
    </aside>

    <!-- ===== PRODUCTOS ===== -->
    <div class="col-12 col-md-7 col-lg-8">
      <div class="bg-dark tienda-container p-4 rounded">

        {% if productos %}
          <div class="row g-4 justify-content-center">

            {% for producto in productos %}
              <div class="col-6 col-md-4 col-lg-3 d-flex">
                <div class="card producto-card border-0 text-light w-100 h-100 d-flex flex-column position-relative">

                  <!-- Imagen -->
                  {% if producto.imagen %}
                    <img src="{{ producto.imagen.url }}" class="card-img-top producto-img" alt="{{ producto.nombre }}">
                  {% else %}
                    <img src="{% static 'img/no-image.png' %}" class="card-img-top producto-img" alt="Sin imagen">
                  {% endif %}

                  <!-- Ribbon AGOTADO -->
                  {% if producto.stock == 0 %}
                    <span class="ribbon agotado">AGOTADO</span>
                  {% endif %}

                  <!-- Ribbon OFERTA -->
                  {% if producto.precio_oferta %}
                    <span class="ribbon oferta">OFERTA</span>
                  {% endif %}

                  <div class="card-body text-center d-flex flex-column justify-content-between">

                    <div>
                      <h6 class="card-title fw-semibold text-light producto-nombre" title="{{ producto.nombre }}">
                        {{ producto.nombre }}
                      </h6>

                      <!-- Precios -->
                      {% if producto.precio_oferta %}
                        <p class="producto-precio-oferta">
                          {{ producto.precio_oferta }} $
                        </p>
                        <p class="producto-precio-original">
                          {{ producto.precio }} $
                        </p>
                      {% else %}
                        <p class="producto-precio mb-2">{{ producto.precio }} $</p>
                      {% endif %}

                      <p class="text-muted small mb-3">Stock: {{ producto.stock }}</p>
                    </div>

                    {% if producto.stock > 0 %}
                      <a href="{% url 'carro:agregar' producto.id %}" class="btn btn-add-cart mt-auto">
                        <i class="bi bi-cart-plus me-2"></i> Agregar
                      </a>
                    {% else %}
                      <button class="btn btn-out-stock mt-auto" disabled>
                        <i class="bi bi-x-circle me-2"></i> Sin stock
                      </button>
                    {% endif %}

                  </div>

                </div>
              </div>
            {% endfor %}

          </div>
        {% else %}
          <div class="alert alert-info text-center mt-4 bg-dark border border-secondary text-light">
            {% if query %}
              No se encontraron productos que coincidan con "<strong>{{ query }}</strong>".
            {% elif categoria_seleccionada %}
              No hay productos disponibles en la categoría <strong>{{ categoria_seleccionada.nombre }}</strong>.
            {% else %}
              No hay productos disponibles en este momento.
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>

  </div>
</div>

<!-- ===== ESTILOS ===== -->
<style>

  /* ===== TÍTULOS ===== */
  .tienda-titulo {
    color: #a24df0;
    text-shadow: 0 0 10px rgba(162, 77, 240, 0.3);
  }

  /* ===== CATEGORÍAS ===== */
  .filtro-categorias {
    background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
    border: 1px solid #333;
  }

  .categoria-link {
    display: block;
    color: #b47aff;
    text-decoration: none;
    padding: 0.6rem 0.9rem;
    border-radius: 8px;
    transition: all 0.3s ease;
  }

  .categoria-link:hover {
    background-color: #2a2a2a;
    color: #fff;
  }

  .categoria-link.activa {
    background: linear-gradient(135deg, #4e00cc, #8a2be2);
    color: #fff;
    font-weight: 600;
    border: 1px solid #a24df0;
  }

  /* ===== PRODUCTOS ===== */
  .producto-card {
    background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
    border-radius: 10px;
    transition: all 0.25s ease;
  }

  .producto-card:hover {
    border: 1px solid #a24df0;
    box-shadow: 0 0 15px rgba(162, 77, 240, 0.6);
  }

  .producto-img {
    border-radius: 10px 10px 0 0;
    height: 200px;
    object-fit: cover;
  }

  .producto-nombre {
    font-size: 0.95rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Precio normal */
  .producto-precio {
    color: #b47aff;
    font-size: 1rem;
    font-weight: 600;
  }

  /* Precio oferta */
  .producto-precio-oferta {
    color: #39ff14;
    font-size: 1.1rem;
    font-weight: 700;
  }

  .producto-precio-original {
    color: #888;
    font-size: 0.9rem;
    text-decoration: line-through;
    margin-top: -8px;
  }

  /* Botón agregar */
  .btn-add-cart {
    background-color: #4e00cc;
    color: #fff;
    border-radius: 10px;
    font-weight: 600;
  }

  /* Botón sin stock */
  .btn-out-stock {
    background-color: #333;
    color: #999;
    border-radius: 10px;
  }

  /* ===== RIBBONS ===== */

  /* Ribbon agotado */
  .ribbon.agotado {
    position: absolute;
    top: 10px;
    left: -5px;
    background: linear-gradient(135deg, #cc0000, #ff3b3b);
    color: #fff;
    padding: 3px 10px;
    font-size: 0.75rem;
    font-weight: 700;
    border-radius: 0 5px 5px 0;
    z-index: 10;
  }

  /* Ribbon oferta */
  .ribbon.oferta {
    position: absolute;
    top: 10px;
    right: -5px;
    background: linear-gradient(135deg, #00cc44, #00ff66);
    color: #fff;
    padding: 3px 10px;
    font-size: 0.75rem;
    font-weight: 700;
    border-radius: 5px 0 0 5px;
    box-shadow: 0 0 10px rgba(0, 255, 100, 0.5);
    z-index: 10;
  }

</style>
{% endblock %}
